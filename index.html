<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.I.O.T. TACTICAL OS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- YouTube API will be loaded dynamically in main.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div id="boot-screen" onclick="requestGPS()">
        <div id="boot-text">█ 系統待命 █<br><br><span style="font-size:0.8rem; color:#666">點擊啟動衛星定位</span></div>
    </div>

    <nav class="sidebar-nav">
        <div class="brand"><i class="fas fa-microchip"></i> A.I.O.T. OS</div>
        <div class="nav-item active" onclick="switchView('dashboard')"><i class="fas fa-chart-line"
                style="width:20px"></i> 戰術儀表</div>
        <div class="nav-item" onclick="switchView('ai')"><i class="fas fa-comment-dots" style="width:20px"></i> 指揮中心
        </div>
        <div class="nav-item" onclick="switchView('music')"><i class="fas fa-music" style="width:20px"></i> 聲波模組</div>
        <div class="nav-item" onclick="switchView('system')"><i class="fas fa-cogs" style="width:20px"></i> 系統控制</div>
        <div class="status-bar">
            <div id="conn-dot" class="status-dot"></div> <span id="conn-text">離線模式</span><br>
            <span id="source-display" style="color:var(--cloud)">SOURCE: GFS (US)</span>
        </div>
    </nav>

    <main class="main-content">
        <section id="view-dashboard" class="view-section active">
            <div class="section-title">數據融合監控 (Data Fusion)</div>
            <div class="dashboard-grid">
                <div class="metric-box">
                    <div id="tag-temp" class="source-tag">SCANNING</div>
                    <div class="metric-lbl">溫度 (°C)</div>
                    <div class="metric-val" id="val-temp">--</div>
                </div>
                <div class="metric-box">
                    <div id="tag-humi" class="source-tag">SCANNING</div>
                    <div class="metric-lbl">濕度 (%)</div>
                    <div class="metric-val" id="val-humi">--</div>
                </div>
                <div class="metric-box">
                    <div id="tag-rain" class="source-tag cloud">CLOUD</div>
                    <div class="metric-lbl" style="color:var(--cloud)">降雨機率 (%)</div>
                    <div class="metric-val" id="val-rain" style="color:var(--cloud)">--</div>
                </div>
                <div class="metric-box">
                    <div id="tag-air" class="source-tag">SCANNING</div>
                    <div class="metric-lbl">AQI (品質)</div>
                    <div class="metric-val" id="val-air">--</div>
                </div>
            </div>
            <div class="card tactical-split">
                <div class="chart-col"><canvas id="mainChart"></canvas></div>
                <div class="map-col">
                    <div id="map"></div>
                    <div
                        style="position: absolute; top: 10px; right: 10px; color: var(--accent); z-index: 500; font-size: 0.8rem; font-family: 'Consolas'; pointer-events: none; text-shadow: 0 0 2px #000;">
                        GPS: LOCKED</div>
                </div>
            </div>
        </section>

        <section id="view-ai" class="view-section">
            <div class="section-title">
                Jarvis 指揮核心
                <div style="float:right; display:flex; gap:10px; align-items:center;">
                    <select id="model-select" onchange="updateModel()" class="tactical-select">
                        <option value="claude-opus-4-5-20251101" selected>Claude 4.5 Opus (最強)</option>
                        <option value="claude-sonnet-4-5-20250929">Claude 4.5 Sonnet (備用)</option>
                        <option value="claude-3-7-sonnet-20250219">Claude 3.7 Sonnet (新版)</option>
                        <option value="claude-sonnet-4-20250514">Claude 4.0 Sonnet (舊版)</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash (Google)</option>
                    </select>
                    <button id="voice-toggle" class="btn" style="padding:5px 10px; font-size:0.8rem;"
                        onclick="toggleVoiceOutput()">語音: 開</button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-display" id="chat-box">
                    <div class="ai-msg">指揮官您好，智慧助手已啟動。</div>
                </div>
                <div id="image-preview-container"
                    style="display:none; padding: 10px; background: rgba(0,0,0,0.5); border-top: 1px solid #333;">
                    <div style="display: inline-block; position: relative;">
                        <img id="preview-img" src=""
                            style="max-height: 100px; border-radius: 4px; border: 1px solid var(--accent);">
                        <button onclick="cancelImage()"
                            style="position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;">&times;</button>
                    </div>
                </div>
                <div class="chat-input-bar">
                    <input type="file" id="image-upload" accept="image/*" style="display:none"
                        onchange="handleImageUpload()">
                    <button class="btn" onclick="triggerImageUpload()">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="btn mic-btn" id="btn-mic" onmousedown="startListening()" onmouseup="stopListening()"
                        ontouchstart="startListening()" ontouchend="stopListening()"><i
                            class="fas fa-microphone"></i></button>
                    <input type="text" id="user-input" class="chat-input" placeholder="輸入指令..."
                        onkeypress="handleKey(event)">
                    <button class="btn" onclick="askJarvis()">發送</button>
                </div>
            </div>
        </section>

        <section id="view-music" class="view-section">
            <div class="section-title">戰術串流播放器</div>
            <div class="card sonic-panel">
                <h2 id="track-name" style="color:var(--accent)">等待信號...</h2>
                <div class="yt-screen-frame">
                    <div id="yt-player"></div>
                </div>
                <div class="visualizer" id="viz-bars">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
                <div style="max-width:600px; margin:0 auto; display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="music-query" class="chat-input" placeholder="輸入歌名..."
                        onkeypress="if(event.key==='Enter')searchMusic()">
                    <button class="btn" onclick="searchMusic()"><i class="fas fa-search"></i> 搜尋</button>
                    <button class="btn" onclick="testPlay()" style="border-color:#f59e0b; color:#f59e0b">測試</button>
                </div>
                <div style="display:flex; gap:20px; justify-content:center;">
                    <button class="ctl-btn" onclick="if(ytPlayer && ytPlayer.playVideo) ytPlayer.playVideo()"><i
                            class="fas fa-play"></i></button>
                    <button class="ctl-btn" onclick="if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo()"><i
                            class="fas fa-pause"></i></button>
                    <button class="ctl-btn" onclick="nextTrack()" title="下一首"><i
                            class="fas fa-step-forward"></i></button>
                    <input type="range" min="0" max="100" value="50"
                        onchange="if(ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(this.value)"
                        style="width:100px; accent-color:var(--accent)">
                </div>
            </div>
        </section>

        <section id="view-system" class="view-section">
            <div class="section-title">系統控制</div>
            <div class="card">
                <h3>硬體連線</h3>
                <div class="control-grid">
                    <div class="ctl-btn" onclick="connectSerial()"><i class="fas fa-plug"></i> 連接 ESP32</div>
                    <div class="ctl-btn" onclick="sendCmd('reboot')" style="border-color:#ff4444; color:#ff4444"><i
                            class="fas fa-power-off"></i> 重啟硬體</div>
                </div>
            </div>
            <div class="card">
                <h3>情報來源 (Data Source)</h3>
                <div class="control-grid">
                    <div class="ctl-btn" onclick="toggleSource()"><i class="fas fa-globe"></i> 切換來源 (美/日)</div>
                    <div class="ctl-btn" onclick="manualSyncOnline()"><i class="fas fa-sync"></i> 重新偵測天氣</div>
                    <div class="ctl-btn" onclick="requestGPS()"><i class="fas fa-location-crosshairs"></i> 重新鎖定 GPS
                    </div>
                    <div class="ctl-btn" onclick="downloadCSV()"><i class="fas fa-file-csv"></i> 匯出報表</div>
                </div>
            </div>
            <div class="card">
                <h3>系統日誌</h3>
                <div id="sys-log"
                    style="height:150px; overflow-y:auto; font-family:'Courier New'; color:#888; font-size:0.8rem; background:#000; padding:10px;">
                </div>
            </div>
        </section>
    </main>

    <script src="main.js"></script>
</body>

</html>
