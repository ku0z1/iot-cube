<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A.I.O.T. TACTICAL OS v27.0 [SINGLE BUTTON]</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root { 
    --bg: #000000; --sidebar-bg: #0a0a0a; --panel: #111; --border: #333; 
    --accent: #10b981; --cloud: #8b5cf6; --text-main: #e2e8f0; --text-dim: #888; --mic-active: #ff4444;
  }
  * { box-sizing: border-box; }
  body { 
    margin: 0; padding: 0; background: var(--bg); 
    color: var(--text-main); font-family: 'Microsoft JhengHei', 'Consolas', sans-serif; 
    height: 100vh; overflow: hidden; display: flex;
  }
  /* CRT 戰術掃描線效果 */
  body::before {
      content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                  linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
      z-index: 999; background-size: 100% 2px, 3px 100%; pointer-events: none;
  }
  #boot-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; font-family: 'Courier New', monospace; color: var(--accent); cursor: pointer; }
  
  .sidebar-nav { width: 250px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 100; }
  .brand { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 30px; letter-spacing: 2px; }
  .nav-item { padding: 15px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; color: var(--text-dim); transition: 0.2s; display: flex; align-items: center; gap: 15px; font-size: 1rem; }
  .nav-item:hover { background: #1a1a1a; color: #fff; }
  .nav-item.active { background: rgba(16, 185, 129, 0.1); color: var(--accent); border: 1px solid var(--accent); }
  .status-bar { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); font-size: 0.8rem; color: #666; }
  .status-dot { width: 8px; height: 8px; background: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
  .status-dot.online { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

  .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; background-image: radial-gradient(circle, #151515 1px, transparent 1px); background-size: 30px 30px; }
  .view-section { display: none; animation: fadeIn 0.3s; }
  .view-section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .card { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 25px; margin-bottom: 20px; }
  .section-title { font-size: 1.5rem; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 10px; color: #fff; }
  .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
  .metric-box { background: #151515; border: 1px solid #333; padding: 20px; text-align: center; border-radius: 8px; position: relative; }
  .metric-val { font-size: 2.5rem; font-weight: bold; color: #fff; margin: 10px 0; }
  .metric-lbl { color: #888; font-size: 0.9rem; letter-spacing: 1px; }
  .source-tag { position: absolute; top: 8px; right: 8px; font-size: 0.6rem; font-family: 'Courier New'; padding: 2px 6px; border-radius: 4px; border: 1px solid #333; color: #555; }
  .source-tag.sensor { color: var(--accent); border-color: var(--accent); background: rgba(16,185,129,0.1); }
  .source-tag.cloud { color: var(--cloud); border-color: var(--cloud); background: rgba(139,92,246,0.1); }
  
  .tactical-split { display: flex; gap: 20px; height: 400px; margin-top: 20px; flex-wrap: wrap; }
  .chart-col { flex: 2; position: relative; height: 100%; min-width: 300px; }
  .map-col { flex: 1; height: 100%; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; position: relative; background: #000; min-width: 250px; }
  #map { width: 100%; height: 100%; z-index: 1; }
  
  .chat-container { height: 60vh; display: flex; flex-direction: column; background: #050505; border: 1px solid var(--border); border-radius: 8px; }
  .chat-display { flex: 1; padding: 20px; overflow-y: auto; font-size: 1rem; line-height: 1.6; color: #ccc; }
  .chat-input-bar { padding: 15px; background: #111; border-top: 1px solid #333; display: flex; gap: 10px; }
  .chat-input { flex: 1; background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 4px; outline: none; }
  .btn { background: var(--accent); color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
  .mic-btn.listening { background: #ff4444 !important; color: white !important; border-color: #ff4444 !important; animation: pulse 1s infinite; }
  @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,68,68,0.7); } 100% { box-shadow: 0 0 0 15px rgba(255,68,68,0); } }

  .sonic-panel { text-align: center; padding: 20px; }
  .yt-screen-frame { width: 100%; max-width: 640px; height: 360px; margin: 20px auto; background: #000; border: 2px solid #333; border-radius: 4px; position: relative; overflow: hidden; }
  #yt-player { width: 100%; height: 100%; display: block; }
  .visualizer { display: flex; justify-content: center; gap: 5px; height: 30px; margin: 10px 0; align-items: flex-end; }
  .bar { width: 8px; background: #333; transition: height 0.1s; }
  .playing .bar { background: var(--accent); animation: eq 0.5s infinite alternate; }
  .playing .bar:nth-child(odd) { animation-duration: 0.4s; }
  @keyframes eq { 0% { height: 5px; } 100% { height: 30px; } }
  .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
  .ctl-btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 15px; cursor: pointer; transition: 0.2s; text-align: center; border-radius: 6px; }
  .ctl-btn:hover { background: var(--accent); color: #000; }
  
  ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
</style>
</head>
<body>

<div id="boot-screen" onclick="requestGPS()">
    <div id="boot-text">█ 系統待命 █<br><br><span style="font-size:0.8rem; color:#666">點擊啟動衛星定位</span></div>
</div>

<nav class="sidebar-nav">
    <div class="brand"><i class="fas fa-microchip"></i> A.I.O.T. OS</div>
    <div class="nav-item active" onclick="switchView('dashboard')"><i class="fas fa-chart-line" style="width:20px"></i> 戰術儀表</div>
    <div class="nav-item" onclick="switchView('ai')"><i class="fas fa-comment-dots" style="width:20px"></i> 指揮中心</div>
    <div class="nav-item" onclick="switchView('music')"><i class="fas fa-music" style="width:20px"></i> 聲波模組</div>
    <div class="nav-item" onclick="switchView('system')"><i class="fas fa-cogs" style="width:20px"></i> 系統控制</div>
    <div class="status-bar">
        <div id="conn-dot" class="status-dot"></div> <span id="conn-text">離線模式</span><br>
        <span id="source-display" style="color:var(--cloud)">SOURCE: GFS (US)</span>
    </div>
</nav>

<main class="main-content">
    <section id="view-dashboard" class="view-section active">
        <div class="section-title">數據融合監控 (Data Fusion)</div>
        <div class="dashboard-grid">
            <div class="metric-box"><div id="tag-temp" class="source-tag">SCANNING</div><div class="metric-lbl">溫度 (°C)</div><div class="metric-val" id="val-temp">--</div></div>
            <div class="metric-box"><div id="tag-humi" class="source-tag">SCANNING</div><div class="metric-lbl">濕度 (%)</div><div class="metric-val" id="val-humi">--</div></div>
            <div class="metric-box"><div id="tag-rain" class="source-tag cloud">CLOUD</div><div class="metric-lbl" style="color:var(--cloud)">降雨機率 (%)</div><div class="metric-val" id="val-rain" style="color:var(--cloud)">--</div></div>
            <div class="metric-box"><div id="tag-air" class="source-tag">SCANNING</div><div class="metric-lbl">AQI (品質)</div><div class="metric-val" id="val-air">--</div></div>
        </div>
        <div class="card tactical-split">
            <div class="chart-col"><canvas id="mainChart"></canvas></div>
            <div class="map-col">
                <div id="map"></div>
                <div style="position: absolute; top: 10px; right: 10px; color: var(--accent); z-index: 500; font-size: 0.8rem; font-family: 'Consolas'; pointer-events: none; text-shadow: 0 0 2px #000;">GPS: LOCKED</div>
            </div>
        </div>
    </section>

    <section id="view-ai" class="view-section">
        <div class="section-title">Jarvis 指揮核心 <button id="voice-toggle" class="btn" style="float:right; padding:5px 10px; font-size:0.8rem;" onclick="toggleVoiceOutput()">語音: 開</button></div>
        <div class="chat-container">
            <div class="chat-display" id="chat-box"><div class="ai-msg">指揮官您好，A.I.O.T. v27 已上線。請下達指令。</div></div>
            <div class="chat-input-bar">
                <button class="btn mic-btn" id="btn-mic" onmousedown="startListening()" onmouseup="stopListening()" ontouchstart="startListening()" ontouchend="stopListening()"><i class="fas fa-microphone"></i></button>
                <input type="text" id="user-input" class="chat-input" placeholder="輸入指令..." onkeypress="handleKey(event)">
                <button class="btn" onclick="askJarvis()">發送</button>
            </div>
        </div>
    </section>

    <section id="view-music" class="view-section">
        <div class="section-title">戰術串流播放器</div>
        <div class="card sonic-panel">
            <h2 id="track-name" style="color:var(--accent)">等待信號...</h2>
            <div class="yt-screen-frame"><div id="yt-player"></div></div>
            <div class="visualizer" id="viz-bars"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>
            <div style="max-width:600px; margin:0 auto; display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="music-query" class="chat-input" placeholder="輸入歌名..." onkeypress="if(event.key==='Enter')searchMusic()">
                <button class="btn" onclick="searchMusic()"><i class="fas fa-search"></i> 搜尋</button>
                <button class="btn" onclick="testPlay()" style="border-color:#f59e0b; color:#f59e0b">測試</button>
            </div>
            <div style="display:flex; gap:20px; justify-content:center;">
                <button class="ctl-btn" onclick="if(ytPlayer && ytPlayer.playVideo) ytPlayer.playVideo()"><i class="fas fa-play"></i></button>
                <button class="ctl-btn" onclick="if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo()"><i class="fas fa-pause"></i></button>
                <button class="ctl-btn" onclick="nextTrack()" title="下一首"><i class="fas fa-step-forward"></i></button>
                <input type="range" min="0" max="100" value="50" onchange="if(ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(this.value)" style="width:100px; accent-color:var(--accent)">
            </div>
        </div>
    </section>

    <section id="view-system" class="view-section">
        <div class="section-title">系統控制</div>
        <div class="card">
            <h3>硬體連線</h3>
            <div class="control-grid">
                <div class="ctl-btn" onclick="connectSerial()"><i class="fas fa-plug"></i> 連接 ESP32</div>
                <div class="ctl-btn" onclick="sendCmd('reboot')" style="border-color:#ff4444; color:#ff4444"><i class="fas fa-power-off"></i> 重啟硬體</div>
            </div>
        </div>
        <div class="card">
            <h3>情報來源 (Data Source)</h3>
            <div class="control-grid">
                <div class="ctl-btn" onclick="toggleSource()"><i class="fas fa-globe"></i> 切換來源 (美/日)</div>
                <div class="ctl-btn" onclick="manualSyncOnline()"><i class="fas fa-sync"></i> 重新偵測天氣</div>
                <div class="ctl-btn" onclick="requestGPS()"><i class="fas fa-location-crosshairs"></i> 重新鎖定 GPS</div>
                <div class="ctl-btn" onclick="downloadCSV()"><i class="fas fa-file-csv"></i> 匯出報表</div>
            </div>
        </div>
        <div class="card">
            <h3>系統日誌</h3>
            <div id="sys-log" style="height:150px; overflow-y:auto; font-family:'Courier New'; color:#888; font-size:0.8rem; background:#000; padding:10px;"></div>
        </div>
    </section>
</main>

<script>
// ==========================================
// ★★★ 關鍵區域：請在此填入您的 API Key ★★★
// ==========================================
const GEMINI_API_KEY = "AIzaSyBI0S-5hbD7ps0MZvs0JvkscqdlunjiRnU"; 
// ==========================================

const AI_MODEL = "gemini-2.0-flash";
let currentTemp="--", currentHumi="--", currentAir="--", currentDist="--", currentRain="--";
let historyData=[], port, reader, writer, isHardwareConnected=false, chart;
let userLat=null, userLon=null;
let dataSource="GFS"; 
let recognition, isVoiceOutputOn=true, synth=window.speechSynthesis;
let ytPlayer, map, mapMarker;
let musicPlaylist = []; let currentPlayIndex = 0;

function requestGPS() {
    const bootText = document.getElementById('boot-text');
    bootText.innerHTML = "正在連線衛星 (GPS)...<br><span style='font-size:0.8rem; color:#888'>請允許瀏覽器存取位置</span>";
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLat = position.coords.latitude; userLon = position.coords.longitude;
                bootText.innerHTML = `GPS 鎖定完成<br>LAT: ${userLat.toFixed(4)} LON: ${userLon.toFixed(4)}<br><br>正在載入系統...`;
                setTimeout(startSystem, 1000);
            },
            (error) => {
                bootText.innerHTML = "GPS 訊號遺失。<br>請檢查瀏覽器權限或網路。<br><button class='btn' onclick='startSystem()'>強制啟動</button>";
                userLat = 25.0330; userLon = 121.5654;
            }
        );
    } else { alert("不支援 GPS"); startSystem(); }
}

function startSystem() {
    document.getElementById('boot-screen').style.display = 'none';
    initChart(); initMap(); initSpeechRecognition();
    manualSyncOnline(); 
    setInterval(updateSimData, 1000); 
    speak("系統已啟動。等待指令。");
}

function updateSimData() {
    if (!isHardwareConnected) {
        let t = currentTemp; let h = currentHumi;
        if(t === "--") t = 25.0; if(h === "--") h = 60.0;
        t = (parseFloat(t) + (Math.random()*0.2 - 0.1)).toFixed(1);
        h = (parseFloat(h) + (Math.random()*1 - 0.5)).toFixed(0);
        updateUI(t, h, currentAir, currentRain, 0, false);
    }
}

function parseHW(json) { 
    try { 
        const d = JSON.parse(json); 
        if(d.t !== undefined) updateUI(d.t, d.h, currentAir, currentRain, d.d, true); 
        
        if(d.event) {
            writeLog("硬體事件: " + d.event);
            if(d.event === "btn_ptt") {
                const micBtn = document.getElementById('btn-mic');
                if(!document.getElementById('view-ai').classList.contains('active')) {
                    switchView('ai'); setTimeout(() => startListening(), 300);
                } else {
                    if(micBtn.classList.contains('listening')) stopListening(); else startListening();
                }
            }
            if(d.event === "btn_next") {
                if(!document.getElementById('view-music').classList.contains('active')) switchView('music');
                nextTrack();
                document.getElementById('track-name').style.color = "#fff";
                setTimeout(()=>document.getElementById('track-name').style.color = "var(--accent)", 200);
            }
        }
    } catch (e) {} 
}

function updateUI(t, h, a, r, d, isFromHardware) {
    if(isFromHardware) {
        currentTemp=t; currentHumi=h; currentAir=a; currentDist=d;
        setTag('temp', 'SENSOR', 'sensor'); setTag('humi', 'SENSOR', 'sensor'); setTag('air', 'SENSOR (MQ)', 'sensor');
    } else {
        if(!isHardwareConnected) {
            currentTemp=t; currentHumi=h; currentAir=a;
            if(t == 25.0) { setTag('temp', 'SCANNING', 'sensor'); setTag('humi', 'SCANNING', 'sensor'); } 
            else { setTag('temp', 'CLOUD', 'cloud'); setTag('humi', 'CLOUD', 'cloud'); }
        }
    }
    if(r !== undefined) currentRain = r;
    setTag('rain', 'CLOUD', 'cloud');

    document.getElementById('val-temp').innerText = currentTemp;
    document.getElementById('val-humi').innerText = currentHumi;
    document.getElementById('val-air').innerText = currentAir;
    document.getElementById('val-rain').innerText = currentRain;

    const now = new Date().toLocaleTimeString();
    if(chart && chart.data) {
        if(chart.data.labels.length > 20) { chart.data.labels.shift(); chart.data.datasets.forEach(x => x.data.shift()); }
        chart.data.labels.push(now);
        chart.data.datasets[0].data.push(currentTemp === "--" ? 0 : currentTemp);
        chart.data.datasets[1].data.push(currentHumi === "--" ? 0 : currentHumi);
        chart.data.datasets[2].data.push(currentRain === "--" ? 0 : currentRain);
        chart.update('none'); 
    }
    historyData.push({time:now, t:currentTemp, h:currentHumi, a:currentAir, r:currentRain, d:currentDist});
}

async function manualSyncOnline() {
    if(!userLat || !userLon) return;
    writeLog(`連線氣象衛星 (${dataSource})...`);
    document.getElementById('tag-rain').innerText = "SYNCING...";
    try {
        let modelParam = (dataSource === "JMA") ? "&models=jma_seamless" : "&models=gfs_seamless";
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLon}&current=temperature_2m,relative_humidity_2m&hourly=precipitation_probability&timezone=auto${modelParam}`;
        const airUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${userLat}&longitude=${userLon}&current=us_aqi`;
        const [resW, resA] = await Promise.all([fetch(weatherUrl), fetch(airUrl)]);
        const dW = await resW.json(); const dA = await resA.json();
        const rainProb = dW.hourly.precipitation_probability[new Date().getHours()];
        const aqi = dA.current ? dA.current.us_aqi : "--";
        currentRain = rainProb;
        
        if(isHardwareConnected && writer) {
            sendCmd("aqi:" + aqi); 
            writeLog("AQI 已傳送至硬體");
        }

        updateUI(dW.current.temperature_2m, dW.current.relative_humidity_2m, aqi, rainProb, 0, false);
        writeLog(`同步: Rain ${rainProb}% / AQI ${aqi}`);
    } catch(e) {
        writeLog("連線失敗: " + e.message);
        document.getElementById('tag-rain').innerText = "OFFLINE";
    }
}

function setTag(id, text, type) { const el = document.getElementById('tag-'+id); if(el) { el.innerText = text; el.className = "source-tag " + type; } }
function downloadCSV() {
    if(historyData.length === 0) { alert("無數據"); return; }
    let csvContent = "\uFEFF時間,溫度,濕度,AQI,降雨機率,距離\n";
    historyData.forEach(row => { csvContent += `${row.time},${row.t},${row.h},${row.a},${row.r},${row.d}\n`; });
    const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
    link.download = "TACTICAL_REPORT_" + Date.now() + ".csv"; link.click();
}
function toggleSource() { dataSource = (dataSource==="GFS")?"JMA":"GFS"; document.getElementById('source-display').innerText = "SOURCE: " + dataSource; manualSyncOnline(); }
function initMap() {
    if(!userLat) { userLat = 25.0330; userLon = 121.5654; }
    map = L.map('map', { zoomControl: false, attributionControl: false }).setView([userLat, userLon], 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);
    mapMarker = L.circleMarker([userLat, userLon], { color: '#10b981', fillColor: '#10b981', fillOpacity: 0.5, radius: 8 }).addTo(map);
    mapMarker.bindPopup("<b>OP: CURRENT LOCATION</b>").openPopup();
}
async function connectSerial() {
    try {
        port = await navigator.serial.requestPort(); await port.open({ baudRate: 9600 });
        const dec = new TextDecoderStream(); port.readable.pipeTo(dec.writable); reader=dec.readable.getReader();
        const enc = new TextEncoderStream(); enc.readable.pipeTo(port.writable); writer=enc.writable.getWriter();
        isHardwareConnected = true; 
        document.getElementById('conn-dot').classList.add('online'); document.getElementById('conn-text').innerText="硬體連線"; document.getElementById('conn-text').style.color="#10b981";
        writeLog("硬體連線成功！"); readLoop();
    } catch (e) { alert("連線失敗"); }
}
async function readLoop() { let buf = ""; while (true) { const { value, done } = await reader.read(); if (done) break; buf += value; let lines = buf.split('\n'); buf = lines.pop(); for (let l of lines) parseHW(l.trim()); } }
async function sendCmd(cmd) { if (writer) await writer.write(cmd + "\n"); writeLog(`指令: ${cmd}`); }

// ================= Music (Fixed) =================
function onYouTubeIframeAPIReady() { 
    const currentOrigin = window.location.origin;
    ytPlayer = new YT.Player('yt-player', { 
        height:'100%', 
        width:'100%', 
        videoId:'', 
        playerVars:{
            'playsinline':1, 
            'controls':1,
            'origin': currentOrigin 
        }, 
        events:{'onStateChange': onPlayerStateChange, 'onError': onPlayerError} 
    }); 
}
function onPlayerError(e) { 
    writeLog(`YouTube 錯誤 [${e.data}]`);
    document.getElementById('track-name').innerText = "播放錯誤 (版權/限制)";
    document.getElementById('track-name').style.color = "#ff4444";
}
function onPlayerStateChange(e) { 
    const viz=document.getElementById('viz-bars'); const t=document.getElementById('track-name');
    if (e.data == YT.PlayerState.PLAYING) { viz.classList.add('playing'); t.style.color="#fff"; } 
    else { viz.classList.remove('playing'); t.style.color="var(--accent)"; }
    if(e.data === 0) nextTrack();
}
async function searchMusic() {
    const q = document.getElementById('music-query').value; if(!q)return;
    document.getElementById('track-name').innerText = "搜尋中...";
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q=${encodeURIComponent(q)}&type=video&key=${GEMINI_API_KEY}`;
    try {
        const res = await fetch(url); const data = await res.json();
        if(data.error) { alert("API 錯誤：" + data.error.message); return; }
        if(data.items && data.items.length > 0) {
            musicPlaylist = data.items; currentPlayIndex = 0; loadTrack(currentPlayIndex);
            writeLog("清單建立: " + data.items.length + " 首");
        } else alert("無結果");
    } catch(e) { alert("API 連線錯誤: "+e.message); }
}
function loadTrack(index) {
    if(index < 0 || index >= musicPlaylist.length) return;
    const item = musicPlaylist[index];
    document.getElementById('track-name').innerText = `PLAYING [${index+1}/${musicPlaylist.length}]: ${item.snippet.title}`;
    if(ytPlayer && ytPlayer.loadVideoById) ytPlayer.loadVideoById(item.id.videoId);
}
function nextTrack() {
    if(musicPlaylist.length === 0) return;
    currentPlayIndex = (currentPlayIndex + 1) % musicPlaylist.length;
    loadTrack(currentPlayIndex);
}
function testPlay() { if(ytPlayer && ytPlayer.loadVideoById) ytPlayer.loadVideoById("jfKfPfyJRdk"); }
function initSpeechRecognition() {
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition(); recognition.lang = 'zh-TW';
        recognition.onstart = () => document.getElementById('btn-mic').classList.add('listening');
        recognition.onend = () => document.getElementById('btn-mic').classList.remove('listening');
        recognition.onresult = (e) => { document.getElementById('user-input').value = e.results[0][0].transcript; askJarvis(); };
    }
}
function startListening() { if(recognition) recognition.start(); }
function stopListening() { if(recognition) recognition.stop(); }
function toggleVoiceOutput() { isVoiceOutputOn = !isVoiceOutputOn; document.getElementById('voice-toggle').innerText = isVoiceOutputOn ? "語音: 開" : "語音: 關"; }
function speak(text) { if(isVoiceOutputOn) { const u = new SpeechSynthesisUtterance(text.replace(/[*#]/g,'')); u.lang='zh-TW'; synth.speak(u); } }
async function askJarvis() {
    const input = document.getElementById('user-input'); const display = document.getElementById('chat-box');
    const q = input.value.trim(); if (!q) return;
    display.innerHTML += `<div class="user-msg">${q}</div>`; input.value = ""; display.scrollTop = display.scrollHeight;
    if(q.includes("同步") || q.includes("天氣")) { manualSyncOnline(); speak("正在同步。"); return; }
    if(q.includes("音樂")) switchView('music');
    const prompt = `你是戰術AI。位置:${userLat},${userLon}。數據:T=${currentTemp},H=${currentHumi},Rain=${currentRain}%,AQI=${currentAir}。User:${q}`;
    try {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL}:generateContent?key=${GEMINI_API_KEY}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
        const d = await res.json(); 
        if(d.error) { throw new Error(d.error.message); }
        const t = d.candidates[0].content.parts[0].text;
        display.innerHTML += `<div class="ai-msg">${marked.parse(t)}</div>`; speak(t);
    } catch (e) { 
        display.innerHTML += `<div class="ai-msg">[ERR] ${e.message}。請檢查金鑰設定。</div>`; 
        console.error(e);
    }
    display.scrollTop = display.scrollHeight; 
}
function switchView(viewId) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + viewId).classList.add('active');
    if(viewId === 'dashboard' && map) setTimeout(() => map.invalidateSize(), 300);
    uiClick(); 
}
function initChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    chart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [ { label: 'Temp', borderColor: '#fff', data: [] }, { label: 'Humi', borderColor: '#0ea5e9', data: [] }, { label: 'Rain', borderColor: '#8b5cf6', data: [] } ] }, options: { responsive: true, maintainAspectRatio: false, scales:{ x:{display:false}, y:{grid:{color:'#222'}} } } });
}
function writeLog(msg) { const p = document.getElementById('sys-log'); p.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`; p.scrollTop = p.scrollHeight; }
function uiClick() { const a=new (window.AudioContext||window.webkitAudioContext)(); const o=a.createOscillator(); const g=a.createGain(); o.connect(g); g.connect(a.destination); o.frequency.value=1200; g.gain.value=0.05; o.start(); o.stop(a.currentTime+0.05); }
function handleKey(e) { if(e.key === 'Enter') askJarvis(); }
</script>
</body>
</html>
